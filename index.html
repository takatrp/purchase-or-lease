<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#5b8aa3"/>
<title>購入 vs リース 判定ツール（r22）</title>
<style>
  :root{ --bg:#f7f9fb; --card:#ffffff; --ink:#0f172a; --muted:#475569; --brand:#578899; --bad:#b91c1c; --good:#065f46; }
  *{box-sizing:border-box}
  html{-webkit-text-size-adjust:100%}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif}
  body{overflow-x:hidden}
  header{position:sticky;top:0;background:linear-gradient(90deg,#5b8aa3,#7aa4b4);color:#fff;padding:10px 12px;z-index:20}
  header h1{font-size:18px;margin:0}
  main{padding:10px;display:grid;gap:10px;max-width:1100px;margin:0 auto}
  .card{background:var(--card);border-radius:14px;box-shadow:0 4px 16px rgba(2,6,23,.06);padding:10px;margin:0}
  .grid{display:grid;gap:8px}
  .g2{grid-template-columns:1fr}
  @media(min-width:840px){.g2{grid-template-columns:1fr 1fr}}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
  input,select{width:100%;padding:13px;border:1px solid #e2e8f0;border-radius:12px;background:#fff;font-size:16px}
  input.num{font-variant-numeric:tabular-nums}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:8px;align-items:center}
  .row.metric{grid-template-columns:1fr}
  @media(min-width:520px){ .row.metric{grid-template-columns:1fr 180px;} }
  .title{font-weight:700;margin:2px 0 6px;font-size:14px}
  .muted{color:var(--muted)}
  .btn{cursor:pointer;display:inline-flex;gap:8px;align-items:center;border:none;background:var(--brand);color:#fff;padding:14px 16px;border-radius:14px;font-weight:700;justify-content:center;font-size:16px;width:100%}
  .btn.secondary{background:#0f172a}
  .kpi{display:grid;grid-template-columns:1fr;gap:8px}
  @media(min-width:720px){.kpi{grid-template-columns:1fr 1fr}}
  .kpi .box{border:1px dashed #dbe3ec;border-radius:12px;padding:8px}
  /* 明細だけ横スクロール */
  .table-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch}
  table{border-collapse:collapse;font-feature-settings:"tnum" 1,"lnum" 1;width:auto;max-width:none;display:table}
  th,td{padding:8px;border-bottom:1px solid #eef2f7;text-align:right;white-space:nowrap;font-size:13px}
  th:first-child,td:first-child{text-align:left}
  .footer{font-size:12px;color:var(--muted)}
  .pill{display:inline-block;padding:3px 7px;border-radius:999px;background:#eef6fb;color:#0b3954;font-size:12px}
  .chart{width:100%;height:220px;margin-left:0}
  svg,img,canvas{max-width:100%;height:auto}
  pre{white-space:pre-wrap;background:#0f172a10;border:1px dashed #cbd5e1;padding:8px;border-radius:10px;font-size:12px}
  /* === モバイル最適化 === */
  @media(max-width:640px){
    html{font-size:15px}
    header h1{font-size:15px}
    .chart{height:170px}
    #runbar{position:sticky;bottom:0;z-index:30;padding-bottom:calc(8px + env(safe-area-inset-bottom));backdrop-filter:blur(6px);background:rgba(255,255,255,.92);box-shadow:0 -6px 16px rgba(15,23,42,.10)}
    .btn{padding:16px 16px;font-size:16px;border-radius:16px}
    /* 入力幅をスマホ向けに狭める（中央寄せ） */
    .card input,.card select{max-width:300px;width:100%;margin-left:auto;margin-right:auto}
    .kpi .box div{font-size:13px}
  }
</style>
</head>
<body>
<header>
  <h1>購入 vs リース 判定ツール（r22）</h1>
</header>
<main>
  <section class="card">
    <div class="title">前提（共通）</div>
    <div class="grid g2">
      <div>
        <label>分析期間（年）</label>
        <input type="text" class="num" inputmode="numeric" id="years" value="5" data-decimals="0">
      </div>
      <div>
        <label>割引率（税引後・%）<span class="muted">　資金の機会費用/WACC など</span></label>
        <input type="text" class="num" inputmode="decimal" id="disc" value="3.00" data-decimals="2">
      </div>
      <div>
        <label>実効税率（%）</label>
        <input type="text" class="num" inputmode="decimal" id="tax" value="31.00" data-decimals="2">
      </div>
      <div>
        <label>消費税率（%）</label>
        <input type="text" class="num" inputmode="decimal" id="vatRate" value="10.00" data-decimals="2">
      </div>
      <div>
        <label>仕入税額控除割合（%）<span class="muted">　原則100%、簡易課税・共通対応は任意%</span></label>
        <input type="text" class="num" inputmode="decimal" id="vatCreditRatio" value="100.00" data-decimals="2">
      </div>
      <div>
        <label>表記</label>
        <select id="fmt">
          <option value="auto" selected>自動（万円に丸め）</option>
          <option value="yen">円（カンマ）</option>
        </select>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="title">購入シナリオ</div>
    <div class="grid g2">
      <div>
        <label>購入価額（税抜）</label>
        <input type="text" class="num" inputmode="decimal" id="buyPrice" value="5,000,000" data-decimals="0">
      </div>
      <div>
        <label>耐用年数（年）<span class="muted">　定額法・残存1円で計算</span></label>
        <input type="text" class="num" inputmode="numeric" id="life" value="5" data-decimals="0">
      </div>
      <div>
        <label>借入割合（%）</label>
        <input type="text" class="num" inputmode="decimal" id="debtRatio" value="100.00" data-decimals="2">
      </div>
      <div>
        <label>借入金利（年率%）</label>
        <input type="text" class="num" inputmode="decimal" id="loanRate" value="2.00" data-decimals="2">
      </div>
      <div>
        <label>借入返済年数（年）<span class="muted">　元利均等</span></label>
        <input type="text" class="num" inputmode="numeric" id="loanYears" value="5" data-decimals="0">
      </div>
      <div>
        <label>保有コスト（年額・税抜）<span class="muted">　保守・保険・固定資産税 等</span></label>
        <input type="text" class="num" inputmode="decimal" id="holdingCost" value="100,000" data-decimals="0">
      </div>
      <div>
        <label>最終処分/売却価額（税抜・+で収入）</label>
        <input type="text" class="num" inputmode="decimal" id="salvage" value="0" data-decimals="0">
      </div>
    </div>
  </section>

  <section class="card">
    <div class="title">リースシナリオ</div>
    <div class="grid g2">
      <div>
        <label>リース料（年額・税抜）</label>
        <input type="text" class="num" inputmode="decimal" id="leasePay" value="1,100,000" data-decimals="0">
      </div>
      <div>
        <label>リース年数（年）</label>
        <input type="text" class="num" inputmode="numeric" id="leaseYears" value="5" data-decimals="0">
      </div>
      <div>
        <label>初回費用（税抜）<span class="muted">　保証料・設定費等</span></label>
        <input type="text" class="num" inputmode="decimal" id="leaseInit" value="0" data-decimals="0">
      </div>
      <div>
        <label>満了時買取額（税抜・任意）</label>
        <input type="text" class="num" inputmode="decimal" id="leaseBuyout" value="0" data-decimals="0">
      </div>
      <div>
        <label>消費税控除のタイミング</label>
        <select id="leaseVatTiming">
          <option value="upfront" selected>一括控除（引渡時）</option>
          <option value="spread">分割控除（支払期日ごと）</option>
        </select>
      </div>
      <div>
        <label>保守等の付帯費用（年額・税抜）</label>
        <input type="text" class="num" inputmode="decimal" id="leaseMaint" value="0" data-decimals="0">
      </div>
    </div>
  </section>

  <section class="card" id="runbar">
    <div class="grid g2">
      <button class="btn" id="run">試算する</button>
      <button class="btn secondary" id="sample">サンプルを読み込む</button>
    </div>
  </section>

  <section class="card">
    <div class="title">判定</div>
    <div class="kpi">
      <div class="box">
        <div class="muted">購入の現在価値（NPC）</div>
        <div id="buyNPV" style="font-size:20px;font-weight:800">-</div>
        <div class="muted">等価年額（EAC）<span class="pill" id="buyEAC">-</span></div>
      </div>
      <div class="box">
        <div class="muted">リースの現在価値（NPC）</div>
        <div id="leaseNPV" style="font-size:20px;font-weight:800">-</div>
        <div class="muted">等価年額（EAC）<span class="pill" id="leaseEAC">-</span></div>
      </div>
    </div>
    <p id="verdict" style="font-weight:800"></p>
    <div id="crossover" class="muted"></div>
    <div class="row metric">
      <span class="muted">グラフ指標</span>
      <select id="metric">
        <option value="PV" selected>PV累計コスト（NPC）</option>
        <option value="ANNUAL">年度コスト（税後）</option>
      </select>
    </div>
    <div id="chartArea" class="chart"></div>
  </section>

  <section class="card">
    <div class="title">キャッシュフロー明細（税効果込・消費税控除反映）</div>
    <div id="tables"></div>
  </section>

  <section class="card">
    <div class="title">開発者テスト（r22）</div>
    <div class="grid g2">
      <button class="btn" id="runTests">自己診断を実行</button>
      <div class="muted">※機能は本体に影響しません。結果は下のログに表示されます。</div>
    </div>
    <pre id="testLog">未実行</pre>
    <pre id="errLog">エラーログなし</pre>
  </section>

  <section class="footer card">
    <div>※本ツールは一般的な比較モデル（税引後キャッシュフローの現在価値と等価年額）に基づく参考計算です。実際の会計・税務処理は契約条件・会計基準・税法解釈により異なるため、最終判断は社内方針・顧問税理士の確認のうえ行ってください。<br>© Matsumoto Kaikei / r22</div>
  </section>

  <section class="card" id="actions">
    <div class="title">出力</div>
    <div class="grid g2">
      <button class="btn" id="copyBtn">コピー</button>
      <button class="btn" id="csvBtn">CSV出力</button>
      <button class="btn secondary" id="printBtn">印刷</button>
    </div>
  </section>

</main>

<script>
// ====== DOM util ======
function byId(id){ return document.getElementById(id); }

// ====== エラーログ補助 ======
function logError(where,msg){
  try{ var el=byId('errLog'); if(el){ el.textContent='['+where+'] '+msg; } }catch(e){}
  try{ console.error('[buy-vs-lease]', where, msg); }catch(e){}
}
window.onerror=function(m,src,ln,col,err){ logError('window.onerror', (m||'')+' @'+(ln||'')+':'+(col||'')); };
window.addEventListener('unhandledrejection', function(e){ logError('unhandledrejection', (e && e.reason && e.reason.message) ? e.reason.message : 'promise rejection'); });

// ====== 全角→半角 正規化 ======
function normalizeNumString(s){
  if(s==null) return '';
  var src=String(s), out='';
  for(var i=0;i<src.length;i++){
    var c=src[i];
    var code=c.charCodeAt(0);
    if(code>=0xFF10 && code<=0xFF19){ out+=String.fromCharCode(code-0xFF10+0x30); continue; }
    if(c==='．'){ out+='.'; continue; }
    if(c==='，' || c==='、'){ out+=','; continue; }
    if(c==='－' || c==='ー'){ out+='-'; continue; }
    if(c==='＋'){ out+='+'; continue; }
    if(c==='％'){ out+='%'; continue; }
    out+=c;
  }
  return out;
}

// ====== フォーマット & 入力補助 ======
function fmtChoice(){ var el=byId('fmt'); return el? el.value : 'auto'; }
function yenFmt(n){ if(fmtChoice()==='auto'){ return (n/10000).toFixed(1).replace(/\B(?=(\d{3})+(?!\d))/g,',')+' 万円'; } return Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g,',')+' 円'; }
function splitNumStr(s){ s = normalizeNumString(s); var neg=false; if(s.indexOf('-')===0){neg=true; s=s.slice(1);} var int='',dec='',dot=false; for(var i=0;i<s.length;i++){ var ch=s[i]; if(ch>='0'&&ch<='9'){ if(dot) dec+=ch; else int+=ch; } else if(ch==='.'&&!dot){ dot=true; } }
  return {neg:neg,int:int,dec:dec, hadDot:dot, raw:s}; }
function thousands(intPart){ if(!intPart) intPart='0'; if(intPart.length<=3) return intPart; var out=''; var n=intPart.length; for(var i=0;i<n;i++){ out+=intPart[i]; var rem=n-i-1; if(rem>0&&rem%3===0) out+=','; } return out; }
function fmtInputString(v,maxDec,keepDot){ if(v==null||v==='') return ''; var p=splitNumStr(v); var d=p.dec; if(typeof maxDec==='number') d=p.dec.slice(0,maxDec); var s=thousands(p.int); if(d){ s+='.'+d; } else if(keepDot && maxDec && maxDec>0){ s+='.'; }
  return (p.neg?'-':'')+s; }
function toNum(v){ if(v==null||v==='') return 0; var p=splitNumStr(v); var str=(p.neg?'-':'')+(p.int?p.int:'0')+(p.dec?'.'+p.dec:''); var num=Number(str); return isNaN(num)?0:num; }
function getVal(id){ var el=byId(id); return el? toNum(el.value):0; }
function setVal(id,v){ var el=byId(id); if(!el) return; var decs=el.dataset && el.dataset.decimals ? parseInt(el.dataset.decimals,10):null; el.value=fmtInputString(v,decs,false); }
function bindFormatters(){ var nodes=document.querySelectorAll('input.num'); for(var i=0;i<nodes.length;i++){ (function(el){ var decs=el.dataset && el.dataset.decimals ? parseInt(el.dataset.decimals,10):null; el.value=fmtInputString(el.value,decs,false); el.addEventListener('input',function(){ var before=el.value; var raw=normalizeNumString(before); var keepDot=/[\.．]$/.test(raw); var pos=el.selectionStart||before.length; var after=fmtInputString(before,decs,keepDot); el.value=after; var delta=after.length-before.length; var newPos=Math.max(0,Math.min(after.length,pos+delta)); try{ el.setSelectionRange(newPos,newPos);}catch(e){} }); el.addEventListener('change',function(){ el.value=fmtInputString(el.value,decs,false); }); el.addEventListener('blur',function(){ el.value=fmtInputString(el.value,decs,false); }); })(nodes[i]); }
}

// ====== 共通計算関数 ======
function npv(rate,cfs){ var s=0; for(var t=0;t<cfs.length;t++){ s+= cfs[t]/Math.pow(1+rate,t); } return s; }
function eacFromNPV(rate,npvVal,years){ if(years<=0) years=1; if(rate===0) return npvVal/years; return rate*npvVal/(1-Math.pow(1+rate,-years)); }
function amortization(loan,rate,nYears){ var n=Math.max(1,Math.round(nYears)); var r=rate; var pay=r===0? loan/n : loan*((r*Math.pow(1+r,n))/(Math.pow(1+r,n)-1)); var bal=loan; var rows=[]; for(var y=1;y<=n;y++){ var interest=bal*r; var principal=pay-interest; bal=Math.max(0,bal-principal); rows.push({year:y,pay:pay,interest:interest,principal:principal,bal:bal}); } return {pay:pay,rows:rows}; }
function fmt(n){ return (n>=0?'':'-')+yenFmt(Math.abs(n)); }
function buildTables(title,rows){ var th='<tr><th>年</th><th>営業CF</th><th>投資/初期</th><th>税効果</th><th>消費税控除</th><th>金融CF</th><th>合計CF</th></tr>'; var trs=''; for(var i=0;i<rows.length;i++){ var r=rows[i]; trs+= '<tr><td>'+r.year+'</td><td>'+fmt(r.ocf)+'</td><td>'+fmt(r.capex)+'</td><td>'+fmt(r.tax)+'</td><td>'+fmt(r.vat)+'</td><td>'+fmt(r.fin)+'</td><td><b>'+fmt(r.total)+'</b></td></tr>'; } return '<h3 style="margin:8px 0">'+title+'</h3><div class="table-scroll"><table>'+th+trs+'</table></div>'; }

// —— 判定グラフ描画（SVG・左寄せ・線グラフ） ——
function renderChart(metric){
  var el=byId('chartArea'); if(!el||!window._rows){return;}
  var rowsB=window._rows.buyRows, rowsL=window._rows.leaseRows, disc=window._rows.disc||0;
  function series(rows){ var out=[], s=0; for(var t=0;t<rows.length;t++){ var v = rows[t] && isFinite(rows[t].total)? rows[t].total : 0; if(metric==='PV'){ s += v/Math.pow(1+disc,t); out.push(-s); } else { out.push(-v); } } return out; }
  var A=series(rowsB), B=series(rowsL);
  var w=Math.max(260,(el.getBoundingClientRect().width||el.clientWidth||360));
  var h=(window.innerWidth<=640)?170:220; var padL=(window.innerWidth<=640)?28:36, padR=16, padT=14, padB=26;
  var N=Math.max(A.length,B.length); var xstep=(w-padL-padR)/Math.max(1,N-1);
  var min=0, max=0; for(var i=0;i<A.length;i++){ if(isFinite(A[i])){ if(A[i]<min) min=A[i]; if(A[i]>max) max=A[i]; } } for(var j=0;j<B.length;j++){ if(isFinite(B[j])){ if(B[j]<min) min=B[j]; if(B[j]>max) max=B[j]; } }
  if(max===min){ max=min+1; }
  function y(v){ v=isFinite(v)?v:0; return padT + (h-padT-padB) * (1-(v-min)/(max-min)); }
  function x(i){ return padL + i*xstep; }
  function poly(ser){ var pts=''; for(var k=0;k<ser.length;k++){ pts += x(k)+','+y(ser[k])+' '; } return pts.trim(); }
  function circles(ser, color){ var out=''; for(var k=0;k<ser.length;k++){ out+='<circle cx="'+x(k)+'" cy="'+y(ser[k])+'" r="3" fill="'+color+'" fill-opacity="0.6"></circle>'; } return out; }
  var y0=y(0);
  var fontSmall=(window.innerWidth<=640)?11:12;
  function lastLabel(ser, name, dx){ var i=Math.max(0, ser.length-1); var val=isFinite(ser[i])?ser[i]:0; var lx=x(i)+dx, ly=y(val)-6; return '<text x="'+lx+'" y="'+ly+'" font-size="'+fontSmall+'" fill="#0f172a">'+name+'：'+yenFmt(val)+'</text>'; }
  var legendX=padL, legendY=fontSmall+6;
  var svg='<svg width="100%" height="'+h+'" viewBox="0 0 '+w+' '+h+'" preserveAspectRatio="xMinYMin meet" style="background:#fff;border:1px dashed #e5edf5;border-radius:12px">'
    + '<line x1="'+padL+'" y1="'+y0+'" x2="'+(w-padR)+'" y2="'+y0+'" stroke="#cbd5e1" stroke-width="1"></line>'
    + '<polyline fill="none" stroke="#3b82f6" stroke-width="2.5" points="'+poly(A)+'"></polyline>'
    + '<polyline fill="none" stroke="#22c55e" stroke-width="2.5" points="'+poly(B)+'"></polyline>'
    + circles(A,'#0f172a')
    + circles(B,'#0f172a')
    + '<rect x="'+legendX+'" y="4" width="10" height="10" rx="2" fill="#3b82f6"></rect>'
    + '<text x="'+(legendX+16)+'" y="'+legendY+'" font-size="'+fontSmall+'" fill="#475569">購入</text>'
    + '<rect x="'+(legendX+60)+'" y="4" width="10" height="10" rx="2" fill="#22c55e"></rect>'
    + '<text x="'+(legendX+76)+'" y="'+legendY+'" font-size="'+fontSmall+'" fill="#475569">リース</text>'
    + lastLabel(A,'購入',8)
    + lastLabel(B,'リース',8)
    + '</svg>';
  el.innerHTML=svg;
}

function computeCrossover(buyRows,leaseRows,disc){
  var years=buyRows.length-1;
  function pvCostTo(rows,upto){ var s=0; for(var t=0;t<=upto;t++){ s+=rows[t].total/Math.pow(1+disc,t); } return -s; }
  function winnerAt(y){ return pvCostTo(buyRows,y)<=pvCostTo(leaseRows,y)?'購入':'リース'; }
  var finalWinner=winnerAt(years); var flip=null;
  for(var y=0;y<=years;y++){ if(winnerAt(y)!==finalWinner){ flip=y; break; } }
  return {flipYear:flip,finalWinner:finalWinner,horizon:years};
}

// ====== メイン計算 ======
function run(){
  var years=Math.round(getVal('years'));
  var disc=getVal('disc')/100;
  var tax=getVal('tax')/100;
  var vatRate=getVal('vatRate')/100;
  var vatCreditRatio=getVal('vatCreditRatio')/100;
  // Purchase inputs
  var price=getVal('buyPrice');
  var life=Math.round(getVal('life'));
  var debtRatio=getVal('debtRatio')/100;
  var loanRate=getVal('loanRate')/100;
  var loanYears=Math.round(getVal('loanYears'));
  var holding=getVal('holdingCost');
  var salvage=getVal('salvage');
  // Lease inputs
  var leasePay=getVal('leasePay');
  var leaseYears=Math.round(getVal('leaseYears'));
  var leaseInit=getVal('leaseInit');
  var leaseBuyout=getVal('leaseBuyout');
  var leaseVatEl=byId('leaseVatTiming'); var leaseVatTiming=leaseVatEl? leaseVatEl.value : 'upfront';
  var leaseMaint=getVal('leaseMaint');

  // ---------------- Purchase scenario -----------------
  var dep=Math.max(0,(price-1))/ (life>0?life:1);
  var loanAmt=price*debtRatio;
  var loan=amortization(loanAmt,loanRate,Math.max(1,Math.min(loanYears,years)));
  var buyRows=[]; var cfs=[];
  for(var y=0;y<=years;y++){
    var ocf=0,capex=0,fin=0,taxShield=0,vat=0;
    if(y===0){
      var vatCash=price*vatRate; // 支払
      vat= vatCash*vatCreditRatio; // 控除（流入）
      capex=-(price+vatCash);
      if(loanAmt>0){ fin+=loanAmt; }
    } else {
      var depExp=y<=life?dep:0; var taxBaseImpact=-holding - depExp; taxShield=-(taxBaseImpact)*tax; ocf=-holding;
      if(y<=loan.rows.length){ var r=loan.rows[y-1]; fin-=r.pay; taxShield+=r.interest*tax; }
      if(y===years && salvage!==0){ ocf+=salvage; var salvageVAT=salvage*vatRate; ocf+=salvageVAT; vat-=salvageVAT*vatCreditRatio; }
    }
    var total=ocf+capex+taxShield+vat+fin; buyRows.push({year:y,ocf:ocf,capex:capex,tax:taxShield,vat:vat,fin:fin,total:total}); cfs.push(total);
  }
  var buyNPVv=npv(disc,cfs);
  var buyEACv=eacFromNPV(disc,-buyNPVv,Math.max(1,years));

  // ---------------- Lease scenario -----------------
  var leaseRows=[]; cfs=[];
  for(var y2=0;y2<=years;y2++){
    var ocf2=0,capex2=0,fin2=0,taxShield2=0,vat2=0;
    if(y2===0){
      if(leaseInit>0){ var vatCash2=leaseInit*vatRate; capex2=-(leaseInit+vatCash2); vat2=vatCash2*vatCreditRatio; }
      if(leaseVatTiming==='upfront'){
        var totalLeaseBase=leasePay*Math.min(leaseYears,years)+leaseBuyout+leaseMaint*Math.min(leaseYears,years);
        var vatCashAll=totalLeaseBase*vatRate; vat2+=vatCashAll*vatCreditRatio; // 控除のみ前倒し（近似）
      }
    } else {
      if(y2<=leaseYears){ var base=leasePay; var vatCash3=base*vatRate; ocf2-=base; taxShield2+=base*tax; if(leaseVatTiming==='spread') vat2+=vatCash3*vatCreditRatio; }
      if(y2===leaseYears && leaseBuyout>0){ var vatCash4=leaseBuyout*vatRate; ocf2-=leaseBuyout; if(leaseVatTiming==='spread') vat2+=vatCash4*vatCreditRatio; }
      if(leaseMaint>0){ ocf2-=leaseMaint; taxShield2+=leaseMaint*tax; if(leaseVatTiming==='spread') vat2+=leaseMaint*vatRate*vatCreditRatio; }
    }
    var total2=ocf2+capex2+taxShield2+vat2+fin2; leaseRows.push({year:y2,ocf:ocf2,capex:capex2,tax:taxShield2,vat:vat2,fin:fin2,total:total2}); cfs.push(total2);
  }
  var leaseNPVv=npv(disc,cfs);
  var leaseEACv=eacFromNPV(disc,-leaseNPVv,Math.max(1,years));

  // 出力
  var buyNPVEl=byId('buyNPV'); if(buyNPVEl){ buyNPVEl.textContent=(buyNPVv>=0?'':'-')+yenFmt(Math.abs(buyNPVv)); }
  var leaseNPVEl=byId('leaseNPV'); if(leaseNPVEl){ leaseNPVEl.textContent=(leaseNPVv>=0?'':'-')+yenFmt(Math.abs(leaseNPVv)); }
  var buyEACEl=byId('buyEAC'); if(buyEACEl){ buyEACEl.textContent=yenFmt(buyEACv); }
  var leaseEACEl=byId('leaseEAC'); if(leaseEACEl){ leaseEACEl.textContent=yenFmt(leaseEACv); }
  var verdictEl=byId('verdict'); if(verdictEl){ var verdictTxt=(-buyNPVv < -leaseNPVv)?'購入のコスト（NPC/EAC）が小さく、有利と判定しました。' : (-leaseNPVv < -buyNPVv)?'リースのコスト（NPC/EAC）が小さく、有利と判定しました。' : '両者はほぼ同等です。契約条件の見直しをご検討ください。'; verdictEl.textContent=verdictTxt+'（分析期間：'+years+'年）'; }

  // 明細テーブル（先に描画）
  var tablesDiv=byId('tables'); if(tablesDiv){ tablesDiv.innerHTML=buildTables('購入',buyRows)+buildTables('リース',leaseRows); }

  // 逆転年
  var cross=computeCrossover(buyRows,leaseRows,disc);
  var ctext=''; if(cross.flipYear===null){ ctext='分析期間（'+cross.horizon+'年）内に逆転はありません（'+cross.finalWinner+'有利が継続）。'; } else { var other=cross.finalWinner==='購入'?'リース':'購入'; ctext='逆転年：'+cross.flipYear+'年目（逆転前：'+other+'有利 → 逆転後：'+cross.finalWinner+'有利）'; }
  var cx=byId('crossover'); if(cx){ cx.textContent=ctext; }

  // グラフ用データ + 行データを保持（テスト/出力用）
  window._calc={buyEACv:buyEACv, leaseEACv:leaseEACv, buyNPCost:-buyNPVv, leaseNPCost:-leaseNPVv};
  window._rows={buyRows:buyRows, leaseRows:leaseRows, disc:disc, years:years};
  var metricEl=byId('metric'); if(metricEl){ setTimeout(function(){ renderChart(metricEl.value); },0); setTimeout(function(){ renderChart(metricEl.value); },80); setTimeout(function(){ renderChart(metricEl.value); },200); }
}

function loadSample(){
  try{
    setVal('years',5); setVal('disc','3.00'); setVal('tax','31.00'); setVal('vatRate','10.00'); setVal('vatCreditRatio','100.00');
    setVal('buyPrice','5000000'); setVal('life',5); setVal('debtRatio','100.00'); setVal('loanRate','2.00'); setVal('loanYears',5); setVal('holdingCost','100000'); setVal('salvage','0');
    setVal('leasePay','1100000'); setVal('leaseYears',5); setVal('leaseInit','0'); setVal('leaseBuyout','0'); var el=byId('leaseVatTiming'); if(el){ el.value='upfront'; } setVal('leaseMaint','0');
    run();
  }catch(e){ logError('loadSample', e.message||e); }
}

// ====== 出力ユーティリティ ======
function csvEscape(v){ if(v==null) return ""; var s=String(v); return (s.indexOf(',')>=0||s.indexOf('"')>=0||s.indexOf('\n')>=0) ? '"'+s.replace(/"/g,'""')+'"' : s; }
function buildCSVString(rowsObj){ var buyRows=rowsObj.buyRows; var leaseRows=rowsObj.leaseRows; var lines=['Scenario,Year,OCF,CAPEX,Tax,VAT,Financing,Total']; function pushRows(name,rows){ for(var i=0;i<rows.length;i++){ var r=rows[i]; lines.push([name,r.year,r.ocf,r.capex,r.tax,r.vat,r.fin,r.total].map(csvEscape).join(',')); } } pushRows('購入',buyRows); pushRows('リース',leaseRows); return '\uFEFF'+lines.join('\n'); }
function exportCSV(){ if(!window._rows){ alert('先に試算してください。'); return; } var csv=buildCSVString(window._rows); var blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); function pad(n){ return String(n).padStart(2,'0'); } var dt=new Date(); a.download='buy_vs_lease_r22_'+dt.getFullYear()+pad(dt.getMonth()+1)+pad(dt.getDate())+'_'+pad(dt.getHours())+pad(dt.getMinutes())+pad(dt.getSeconds())+'.csv'; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
function copyResult(){ var verdictEl=byId('verdict'); var buyNPVEl=byId('buyNPV'); var leaseNPVEl=byId('leaseNPV'); var buyEACEl=byId('buyEAC'); var leaseEACEl=byId('leaseEAC'); var crossEl=byId('crossover'); var text=['【判定】', verdictEl?verdictEl.textContent:'', '購入 NPC/EAC: '+(buyNPVEl?buyNPVEl.textContent:'')+' / '+(buyEACEl?buyEACEl.textContent:''), 'リース NPC/EAC: '+(leaseNPVEl?leaseNPVEl.textContent:'')+' / '+(leaseEACEl?leaseEACEl.textContent:''), (crossEl?crossEl.textContent:'')].join('\n'); try{ if(navigator.clipboard && navigator.clipboard.writeText){ navigator.clipboard.writeText(text).then(function(){ alert('判定結果をコピーしました'); }, function(){ alert(text); }); } else { throw new Error('no clipboard'); } } catch(e){ alert(text); } }

// ====== テスト ======
function runSelfTests(){
  var log=[]; function write(s){ log.push(s); }
  function ok(name,cond){ write((cond?'✅ ':'❌ ')+name); if(!cond) throw new Error(name); }
  function step(name,fn){ try{ fn(); write('— '+name+' OK'); } catch(e){ write('— '+name+' ERROR: '+e.message); } }
  try{
    step('初期サンプルで実行', function(){ loadSample(); ok('tables に表が描画', byId('tables').innerHTML.indexOf('<table>')>=0); ok('グラフSVGが描画', byId('chartArea').innerHTML.indexOf('<svg')>=0); });
    step('金利2桁小数が正しく解釈', function(){ setVal('loanRate','2.34'); var v=getVal('loanRate'); ok('≈2.34', Math.abs(v-2.34)<1e-9); });
    step('行データ件数（年数+1）', function(){ var r=window._rows; var yrs=r.years; ok('購入行数', r.buyRows.length===yrs+1); ok('リース行数', r.leaseRows.length===yrs+1); });
    step('逆転年APIの一貫性', function(){ var r=window._rows; var cross=computeCrossover(r.buyRows,r.leaseRows,r.disc); ok('horizon=years', cross.horizon===r.years); });
    step('指標切替で再描画', function(){ var sel=byId('metric'); sel.value='ANNUAL'; renderChart(sel.value); ok('ANNUAL描画', byId('chartArea').innerHTML.indexOf('<svg')>=0); sel.value='PV'; renderChart(sel.value); ok('PV描画', byId('chartArea').innerHTML.indexOf('<svg')>=0); });
    step('CSV生成行数', function(){ var r=window._rows; var csv=buildCSVString(r); var lines=csv.split('\n'); var expect=1+(r.years+1)*2; ok('ヘッダ+明細行数', lines.length===expect); });
    step('全角数値の解釈（割引率）', function(){ setVal('disc','３．２５'); var v=getVal('disc'); ok('≈3.25', Math.abs(v-3.25)<1e-9); });
    step('全角カンマの解釈（購入価額）', function(){ setVal('buyPrice','５，０００，０００'); var v=getVal('buyPrice'); ok('=5000000', v===5000000); });
    step('小数点打鍵の保持（3. → 3.）', function(){ var out=fmtInputString('3.',2,true); ok('"3."維持', out==='3.'); });
  } finally {
    var tg=byId('testLog'); if(tg){ tg.textContent=log.join('\n'); }
  }
}

// ====== 起動処理 ======
function scheduleChart(){ var metricEl=byId('metric'); var m=metricEl? metricEl.value : 'PV'; setTimeout(function(){ renderChart(m); },0); setTimeout(function(){ renderChart(m); },80); setTimeout(function(){ renderChart(m); },200); }
function ensureRender(attempt){ attempt = attempt||1; var max=5; var tbl=byId('tables'); var chr=byId('chartArea'); var okT=tbl && tbl.querySelector && tbl.querySelector('table'); var okC=chr && chr.querySelector && chr.querySelector('svg'); if(okT && okC) return; if(attempt<=max){ setTimeout(function(){ try{ if(!window._rows){ run(); } scheduleChart(); }catch(e){ logError('ensureRender', e.message||e); } ensureRender(attempt+1); }, 140*attempt); } }
function runSafe(){ try{ run(); } catch(e){ logError('run', e.message||e); } }

function initApp(){
  if(window._inited) return; window._inited=true;
  try{
    bindFormatters();
    var runBtn=byId('run'); if(runBtn){ runBtn.addEventListener('click', function(){ runSafe(); scheduleChart(); ensureRender(1); }); }
    var sampBtn=byId('sample'); if(sampBtn){ sampBtn.addEventListener('click', function(){ loadSample(); scheduleChart(); ensureRender(1); }); }
    var metricEl=byId('metric'); if(metricEl){ metricEl.addEventListener('change', function(){ scheduleChart(); ensureRender(1); }); }
    var testBtn=byId('runTests'); if(testBtn){ testBtn.addEventListener('click', runSelfTests); }
    if('ResizeObserver' in window){ var chartArea=byId('chartArea'); if(chartArea){ try{ new ResizeObserver(function(){ scheduleChart(); }).observe(chartArea); }catch(e){} } }
    var copyBtn=byId('copyBtn'); if(copyBtn){ copyBtn.addEventListener('click', copyResult); }
    var csvBtn=byId('csvBtn'); if(csvBtn){ csvBtn.addEventListener('click', exportCSV); }
    var printBtn=byId('printBtn'); if(printBtn){ printBtn.addEventListener('click', function(){ window.print(); }); }
    // 初回実行
    loadSample();
    runSafe();
    scheduleChart();
    ensureRender(1);
    setTimeout(function(){ runSafe(); scheduleChart(); ensureRender(2); }, 250);
    setTimeout(function(){ runSafe(); scheduleChart(); ensureRender(3); }, 800);
  }catch(e){ logError('initApp', e.message||e); }
}

document.addEventListener('DOMContentLoaded', initApp);
window.addEventListener('load', initApp);
window.addEventListener('visibilitychange', function(){ if(!document.hidden){ runSafe(); scheduleChart(); ensureRender(1); }});
setTimeout(function(){ if(!window._inited){ initApp(); } }, 500);
try{ initApp(); }catch(e){ logError('immediateInit', e.message||e); }
</script>
</body>
</html>
